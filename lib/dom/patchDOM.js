'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

exports.default = patchDOM;

var _createDOMNode = require('./createDOMNode');

var _createDOMNode2 = _interopRequireDefault(_createDOMNode);

var _mapProps = require('./mapProps');

var _mapProps2 = _interopRequireDefault(_mapProps);

var _const = require('./const');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var keys = _keys2.default;


function isDOMContainer(el) {
  return !!el.getAttribute(_const.DOMCONTAINER_ATTR_NAME.toLowerCase());
}

function patchDOM(el, vdom) {
  var attrs = Array.prototype.slice.call(el.attributes);
  var inputProps = vdom.props;

  var props = (0, _mapProps2.default)(inputProps);

  attrs.forEach(function (attr) {
    // 注意, DOM属性是不分大小写的
    var name = attr.name;


    if (typeof props[name] === 'undefined') {
      dealWithRemovableAttr(el, name);
      el.removeAttribute(name);
    }
  });

  keys(props).forEach(function (key) {
    var value = props[key];
    var currentDOMValue = el.getAttribute(key);

    if (value !== currentDOMValue) {
      dealWithDifferentAttr(el, key, value, currentDOMValue);
    }
  });

  if (isDOMContainer(el)) {
    return;
  }

  var newDOMChildren = [];
  var domChildren = Array.prototype.slice.call(el.children);
  var domChildrenBackup = Array.prototype.slice.call(el.children);
  var vdomChildren = vdom.children.filter(function (child) {
    return !!child;
  });

  vdomChildren.forEach(function (vdomChild) {
    var domChild = domChildren.shift();

    if (!domChild || vdomChild.tag !== domChild.tagName) {
      var newNode = (0, _createDOMNode2.default)(vdomChild);
      if (newNode.nodeType !== 3) {
        newDOMChildren.push(newNode);
      }
    } else {
      patchDOM(domChild, vdomChild);
      newDOMChildren.push(domChild);
    }
  });

  domChildrenBackup.forEach(function (child) {
    return el.removeChild(child);
  });
  newDOMChildren.forEach(function (child) {
    return el.appendChild(child);
  });
}

function dealWithRemovableAttr(el, name) {
  el.removeAttribute(name);
}

function dealWithDifferentAttr(el, name, newValue, currentValue) {
  el.setAttribute(name, newValue);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9kb20vcGF0Y2hET00uanMiXSwibmFtZXMiOlsicGF0Y2hET00iLCJrZXlzIiwiaXNET01Db250YWluZXIiLCJlbCIsImdldEF0dHJpYnV0ZSIsIkRPTUNPTlRBSU5FUl9BVFRSX05BTUUiLCJ0b0xvd2VyQ2FzZSIsInZkb20iLCJhdHRycyIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwiYXR0cmlidXRlcyIsImlucHV0UHJvcHMiLCJwcm9wcyIsImZvckVhY2giLCJuYW1lIiwiYXR0ciIsImRlYWxXaXRoUmVtb3ZhYmxlQXR0ciIsInJlbW92ZUF0dHJpYnV0ZSIsInZhbHVlIiwia2V5IiwiY3VycmVudERPTVZhbHVlIiwiZGVhbFdpdGhEaWZmZXJlbnRBdHRyIiwibmV3RE9NQ2hpbGRyZW4iLCJkb21DaGlsZHJlbiIsImNoaWxkcmVuIiwiZG9tQ2hpbGRyZW5CYWNrdXAiLCJ2ZG9tQ2hpbGRyZW4iLCJmaWx0ZXIiLCJjaGlsZCIsImRvbUNoaWxkIiwic2hpZnQiLCJ2ZG9tQ2hpbGQiLCJ0YWciLCJ0YWdOYW1lIiwibmV3Tm9kZSIsIm5vZGVUeXBlIiwicHVzaCIsInJlbW92ZUNoaWxkIiwiYXBwZW5kQ2hpbGQiLCJuZXdWYWx1ZSIsImN1cnJlbnRWYWx1ZSIsInNldEF0dHJpYnV0ZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztrQkFVd0JBLFE7O0FBVnhCOzs7O0FBQ0E7Ozs7QUFDQTs7OztJQUVRQyxJOzs7QUFFUixTQUFTQyxjQUFULENBQXlCQyxFQUF6QixFQUE2QjtBQUMzQixTQUFPLENBQUMsQ0FBQ0EsR0FBR0MsWUFBSCxDQUFnQkMsOEJBQXVCQyxXQUF2QixFQUFoQixDQUFUO0FBQ0Q7O0FBRWMsU0FBU04sUUFBVCxDQUFtQkcsRUFBbkIsRUFBdUJJLElBQXZCLEVBQTZCO0FBQzFDLE1BQU1DLFFBQVFDLE1BQU1DLFNBQU4sQ0FBZ0JDLEtBQWhCLENBQXNCQyxJQUF0QixDQUEyQlQsR0FBR1UsVUFBOUIsQ0FBZDtBQUQwQyxNQUUzQkMsVUFGMkIsR0FFWlAsSUFGWSxDQUVsQ1EsS0FGa0M7O0FBRzFDLE1BQU1BLFFBQVEsd0JBQVNELFVBQVQsQ0FBZDs7QUFFQU4sUUFBTVEsT0FBTixDQUFjLGdCQUFRO0FBQ3BCO0FBRG9CLFFBRVpDLElBRlksR0FFSEMsSUFGRyxDQUVaRCxJQUZZOzs7QUFJcEIsUUFBSSxPQUFPRixNQUFNRSxJQUFOLENBQVAsS0FBdUIsV0FBM0IsRUFBd0M7QUFDdENFLDRCQUFzQmhCLEVBQXRCLEVBQTBCYyxJQUExQjtBQUNBZCxTQUFHaUIsZUFBSCxDQUFtQkgsSUFBbkI7QUFDRDtBQUNGLEdBUkQ7O0FBVUFoQixPQUFLYyxLQUFMLEVBQVlDLE9BQVosQ0FBb0IsZUFBTztBQUN6QixRQUFNSyxRQUFRTixNQUFNTyxHQUFOLENBQWQ7QUFDQSxRQUFNQyxrQkFBa0JwQixHQUFHQyxZQUFILENBQWdCa0IsR0FBaEIsQ0FBeEI7O0FBRUEsUUFBSUQsVUFBVUUsZUFBZCxFQUErQjtBQUM3QkMsNEJBQXNCckIsRUFBdEIsRUFBMEJtQixHQUExQixFQUErQkQsS0FBL0IsRUFBc0NFLGVBQXRDO0FBQ0Q7QUFDRixHQVBEOztBQVNBLE1BQUlyQixlQUFlQyxFQUFmLENBQUosRUFBd0I7QUFDdEI7QUFDRDs7QUFFRCxNQUFNc0IsaUJBQWlCLEVBQXZCO0FBQ0EsTUFBTUMsY0FBY2pCLE1BQU1DLFNBQU4sQ0FBZ0JDLEtBQWhCLENBQXNCQyxJQUF0QixDQUEyQlQsR0FBR3dCLFFBQTlCLENBQXBCO0FBQ0EsTUFBTUMsb0JBQW9CbkIsTUFBTUMsU0FBTixDQUFnQkMsS0FBaEIsQ0FBc0JDLElBQXRCLENBQTJCVCxHQUFHd0IsUUFBOUIsQ0FBMUI7QUFDQSxNQUFNRSxlQUFldEIsS0FBS29CLFFBQUwsQ0FBY0csTUFBZCxDQUFxQjtBQUFBLFdBQVMsQ0FBQyxDQUFDQyxLQUFYO0FBQUEsR0FBckIsQ0FBckI7O0FBRUFGLGVBQWFiLE9BQWIsQ0FBcUIscUJBQWE7QUFDaEMsUUFBTWdCLFdBQVdOLFlBQVlPLEtBQVosRUFBakI7O0FBRUEsUUFBSSxDQUFDRCxRQUFELElBQWFFLFVBQVVDLEdBQVYsS0FBa0JILFNBQVNJLE9BQTVDLEVBQXFEO0FBQ25ELFVBQU1DLFVBQVUsNkJBQWNILFNBQWQsQ0FBaEI7QUFDQSxVQUFJRyxRQUFRQyxRQUFSLEtBQXFCLENBQXpCLEVBQTRCO0FBQzFCYix1QkFBZWMsSUFBZixDQUFvQkYsT0FBcEI7QUFDRDtBQUNGLEtBTEQsTUFLTztBQUNMckMsZUFBU2dDLFFBQVQsRUFBbUJFLFNBQW5CO0FBQ0FULHFCQUFlYyxJQUFmLENBQW9CUCxRQUFwQjtBQUNEO0FBQ0YsR0FaRDs7QUFjQUosb0JBQWtCWixPQUFsQixDQUEwQjtBQUFBLFdBQVNiLEdBQUdxQyxXQUFILENBQWVULEtBQWYsQ0FBVDtBQUFBLEdBQTFCO0FBQ0FOLGlCQUFlVCxPQUFmLENBQXVCO0FBQUEsV0FBU2IsR0FBR3NDLFdBQUgsQ0FBZVYsS0FBZixDQUFUO0FBQUEsR0FBdkI7QUFDRDs7QUFFRCxTQUFTWixxQkFBVCxDQUFnQ2hCLEVBQWhDLEVBQW9DYyxJQUFwQyxFQUEwQztBQUN4Q2QsS0FBR2lCLGVBQUgsQ0FBbUJILElBQW5CO0FBQ0Q7O0FBRUQsU0FBU08scUJBQVQsQ0FBZ0NyQixFQUFoQyxFQUFvQ2MsSUFBcEMsRUFBMEN5QixRQUExQyxFQUFvREMsWUFBcEQsRUFBa0U7QUFDaEV4QyxLQUFHeUMsWUFBSCxDQUFnQjNCLElBQWhCLEVBQXNCeUIsUUFBdEI7QUFDRCIsImZpbGUiOiJwYXRjaERPTS5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBjcmVhdGVET01Ob2RlIGZyb20gJy4vY3JlYXRlRE9NTm9kZSdcbmltcG9ydCBtYXBQcm9wcyBmcm9tICcuL21hcFByb3BzJ1xuaW1wb3J0IHsgRE9NQ09OVEFJTkVSX0FUVFJfTkFNRSB9IGZyb20gJy4vY29uc3QnXG5cbmNvbnN0IHsga2V5cyB9ID0gT2JqZWN0XG5cbmZ1bmN0aW9uIGlzRE9NQ29udGFpbmVyIChlbCkge1xuICByZXR1cm4gISFlbC5nZXRBdHRyaWJ1dGUoRE9NQ09OVEFJTkVSX0FUVFJfTkFNRS50b0xvd2VyQ2FzZSgpKVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwYXRjaERPTSAoZWwsIHZkb20pIHtcbiAgY29uc3QgYXR0cnMgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChlbC5hdHRyaWJ1dGVzKVxuICBjb25zdCB7IHByb3BzOiBpbnB1dFByb3BzIH0gPSB2ZG9tXG4gIGNvbnN0IHByb3BzID0gbWFwUHJvcHMoaW5wdXRQcm9wcylcblxuICBhdHRycy5mb3JFYWNoKGF0dHIgPT4ge1xuICAgIC8vIOazqOaEjywgRE9N5bGe5oCn5piv5LiN5YiG5aSn5bCP5YaZ55qEXG4gICAgY29uc3QgeyBuYW1lIH0gPSBhdHRyXG5cbiAgICBpZiAodHlwZW9mIHByb3BzW25hbWVdID09PSAndW5kZWZpbmVkJykge1xuICAgICAgZGVhbFdpdGhSZW1vdmFibGVBdHRyKGVsLCBuYW1lKVxuICAgICAgZWwucmVtb3ZlQXR0cmlidXRlKG5hbWUpXG4gICAgfVxuICB9KVxuXG4gIGtleXMocHJvcHMpLmZvckVhY2goa2V5ID0+IHtcbiAgICBjb25zdCB2YWx1ZSA9IHByb3BzW2tleV1cbiAgICBjb25zdCBjdXJyZW50RE9NVmFsdWUgPSBlbC5nZXRBdHRyaWJ1dGUoa2V5KVxuXG4gICAgaWYgKHZhbHVlICE9PSBjdXJyZW50RE9NVmFsdWUpIHtcbiAgICAgIGRlYWxXaXRoRGlmZmVyZW50QXR0cihlbCwga2V5LCB2YWx1ZSwgY3VycmVudERPTVZhbHVlKVxuICAgIH1cbiAgfSlcblxuICBpZiAoaXNET01Db250YWluZXIoZWwpKSB7XG4gICAgcmV0dXJuXG4gIH1cblxuICBjb25zdCBuZXdET01DaGlsZHJlbiA9IFtdXG4gIGNvbnN0IGRvbUNoaWxkcmVuID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZWwuY2hpbGRyZW4pXG4gIGNvbnN0IGRvbUNoaWxkcmVuQmFja3VwID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoZWwuY2hpbGRyZW4pXG4gIGNvbnN0IHZkb21DaGlsZHJlbiA9IHZkb20uY2hpbGRyZW4uZmlsdGVyKGNoaWxkID0+ICEhY2hpbGQpXG5cbiAgdmRvbUNoaWxkcmVuLmZvckVhY2godmRvbUNoaWxkID0+IHtcbiAgICBjb25zdCBkb21DaGlsZCA9IGRvbUNoaWxkcmVuLnNoaWZ0KClcblxuICAgIGlmICghZG9tQ2hpbGQgfHwgdmRvbUNoaWxkLnRhZyAhPT0gZG9tQ2hpbGQudGFnTmFtZSkge1xuICAgICAgY29uc3QgbmV3Tm9kZSA9IGNyZWF0ZURPTU5vZGUodmRvbUNoaWxkKVxuICAgICAgaWYgKG5ld05vZGUubm9kZVR5cGUgIT09IDMpIHtcbiAgICAgICAgbmV3RE9NQ2hpbGRyZW4ucHVzaChuZXdOb2RlKVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBwYXRjaERPTShkb21DaGlsZCwgdmRvbUNoaWxkKVxuICAgICAgbmV3RE9NQ2hpbGRyZW4ucHVzaChkb21DaGlsZClcbiAgICB9XG4gIH0pXG5cbiAgZG9tQ2hpbGRyZW5CYWNrdXAuZm9yRWFjaChjaGlsZCA9PiBlbC5yZW1vdmVDaGlsZChjaGlsZCkpXG4gIG5ld0RPTUNoaWxkcmVuLmZvckVhY2goY2hpbGQgPT4gZWwuYXBwZW5kQ2hpbGQoY2hpbGQpKVxufVxuXG5mdW5jdGlvbiBkZWFsV2l0aFJlbW92YWJsZUF0dHIgKGVsLCBuYW1lKSB7XG4gIGVsLnJlbW92ZUF0dHJpYnV0ZShuYW1lKVxufVxuXG5mdW5jdGlvbiBkZWFsV2l0aERpZmZlcmVudEF0dHIgKGVsLCBuYW1lLCBuZXdWYWx1ZSwgY3VycmVudFZhbHVlKSB7XG4gIGVsLnNldEF0dHJpYnV0ZShuYW1lLCBuZXdWYWx1ZSlcbn1cbiJdfQ==